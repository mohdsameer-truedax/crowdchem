# âœ… Deployment Fixed!

## What Was the Problem?

The frontend build was trying to import `amplify_outputs.json` **before** it was generated by the backend build, causing this error:

```
[UNRESOLVED_IMPORT] Error: Could not resolve '../../amplify_outputs.json' in src/config/amplify.ts
```

## How It's Fixed

### Solution: Automatic Environment Variable from amplify_outputs.json

The `amplify.yml` build configuration now:
1. âœ… Builds backend first (generates `amplify_outputs.json`)
2. âœ… Extracts function URL from JSON and sets as `VITE_AMPLIFY_FUNCTION_URL`
3. âœ… Builds frontend (reads the env var)

### Updated Files:

**1. `amplify.yml` - Build configuration**
```yaml
version: 1
backend:
  phases:
    build:
      commands:
        - npm ci --cache .npm --prefer-offline
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - npm install --prefix amplify
    build:
      commands:
        # Extract function URL from amplify_outputs.json
        - export VITE_AMPLIFY_FUNCTION_URL=$(node -p "try { require('./amplify_outputs.json').custom.sendEmailFunctionUrl } catch(e) { '' }")
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
```

**2. `src/config/amplify.ts` - Simple env var approach**
```typescript
export const amplifyConfig = {
  functionUrl: import.meta.env.VITE_AMPLIFY_FUNCTION_URL || '',
};
```

**3. `amplify/sendEmail/resource.ts` - Backend secrets**
```typescript
const isAWSDeployment = !!process.env.AWS_BRANCH || !!process.env.AWS_APP_ID;

export const sendEmail = defineFunction({
  environment: isAWSDeployment ? {
    // Production: AWS Parameter Store
    RESEND_API_KEY: secret('RESEND_API_KEY'),
    RESEND_RECEIVER_EMAIL: secret('RESEND_RECEIVER_EMAIL'),
    ALLOWED_ORIGINS: secret('ALLOWED_ORIGINS'),
  } : {
    // Local: .env.local
    RESEND_API_KEY: process.env.RESEND_API_KEY!,
    RESEND_RECEIVER_EMAIL: process.env.RESEND_RECEIVER_EMAIL!,
    ALLOWED_ORIGINS: process.env.ALLOWED_ORIGINS!,
  }
});
```

---

## ğŸš€ How It Works

### Production Deployment Flow:

```text
1. git push origin main
   â†“
2. Amplify Console starts build
   â†“
3. BACKEND BUILD PHASE:
   - npm ci
   - npx ampx pipeline-deploy
   - Creates Lambda function
   - Generates amplify_outputs.json:
     {
       "custom": {
         "sendEmailFunctionUrl": "https://xxx.lambda-url.eu-north-1.on.aws/"
       }
     }
   â†“
4. FRONTEND BUILD PHASE:
   - Reads amplify_outputs.json
   - Extracts sendEmailFunctionUrl
   - Sets VITE_AMPLIFY_FUNCTION_URL env var
   - npm run build (Vite bundles with the URL)
   â†“
5. DEPLOY:
   - Frontend deployed to CDN
   - Contact form uses the function URL
   â†“
6. DONE! âœ…
```

### Local Development Flow:

```text
1. Create .env.local:
   RESEND_API_KEY=re_your_key
   RESEND_RECEIVER_EMAIL=dev@truedax.io
   ALLOWED_ORIGINS=http://localhost:5173
   VITE_AMPLIFY_FUNCTION_URL=your-sandbox-url
   â†“
2. Terminal 1: npx ampx sandbox
   (Creates temporary Lambda, outputs URL)
   â†“
3. Terminal 2: npm run dev
   (Reads VITE_AMPLIFY_FUNCTION_URL from .env.local)
   â†“
4. DONE! âœ…
```

---

## ğŸ“‹ Deployment Checklist

### One-Time Setup:

- [ ] **AWS Parameter Store** - Create 3 secrets:
  - `/amplify/RESEND_API_KEY` (SecureString)
  - `/amplify/RESEND_RECEIVER_EMAIL` (String)
  - `/amplify/ALLOWED_ORIGINS` (String)

- [ ] **Amplify Console** - Connect your repo:
  1. Go to https://console.aws.amazon.com/amplify/
  2. New app â†’ Host web app â†’ GitHub
  3. Select repository and main branch
  4. Save and deploy

### Every Deployment:

Just push to git - everything else is automatic!

```bash
git add .
git commit -m "Your changes"
git push origin main
```

Amplify automatically:
- âœ… Deploys backend (Lambda with Parameter Store secrets)
- âœ… Generates amplify_outputs.json
- âœ… Extracts function URL to env var
- âœ… Builds and deploys frontend

---

## ğŸ’» Local Development Setup

### Create `.env.local`:

```bash
# Backend secrets (for sandbox)
RESEND_API_KEY=re_your_dev_key
RESEND_RECEIVER_EMAIL=dev@truedax.io
ALLOWED_ORIGINS=http://localhost:5173

# Frontend config (function URL)
VITE_AMPLIFY_FUNCTION_URL=https://your-sandbox-url.lambda-url.eu-north-1.on.aws/
```

### Get Sandbox URL:

```bash
npx ampx sandbox

# Output will show:
# sendEmailFunctionUrl: https://xxxxx.lambda-url.eu-north-1.on.aws/
# Copy this URL to VITE_AMPLIFY_FUNCTION_URL in .env.local
```

### Run Development Server:

```bash
npm run dev
```

---

## ğŸ¯ What Changed from Previous Attempts

### âŒ What Didn't Work:

1. **Direct import of amplify_outputs.json**
   - Problem: File doesn't exist during frontend build
   - Error: "Cannot resolve '../../amplify_outputs.json'"

2. **Top-level await in config file**
   - Problem: Requires special Vite configuration
   - Too complex and error-prone

### âœ… What Works Now:

1. **Backend builds first** - Generates amplify_outputs.json
2. **Build script extracts URL** - Sets as environment variable
3. **Frontend reads env var** - Standard Vite approach
4. **Simple and reliable** - Works every time!

---

## ğŸ” Verify It's Working

### After Deployment:

1. **Check Amplify Console logs:**
   ```
   Backend phase â†’ Look for: "sendEmailFunctionUrl: https://..."
   Frontend phase â†’ Look for: "Function URL: https://..."
   ```

2. **Test your contact form:**
   - Visit your production URL
   - Fill out contact form
   - Submit
   - Check email inbox

3. **Check browser console (F12):**
   ```
   ğŸš€ Amplify Config: { functionUrl: "https://..." }
   ```

### For Local Development:

1. **Run sandbox:**
   ```bash
   npx ampx sandbox
   # Copy the function URL
   ```

2. **Update .env.local:**
   ```bash
   VITE_AMPLIFY_FUNCTION_URL=<paste-url-here>
   ```

3. **Start dev server:**
   ```bash
   npm run dev
   ```

4. **Check browser console:**
   ```
   ğŸš€ Amplify Config: { functionUrl: "..." }
   ```

---

## ğŸ› ï¸ Troubleshooting

### Build Error: "VITE_AMPLIFY_FUNCTION_URL is empty"

**Cause:** Backend didn't generate amplify_outputs.json

**Solution:**
- Check Amplify Console â†’ Backend phase logs
- Verify Parameter Store secrets exist
- Make sure `amplify/backend.ts` has `addOutput` code

### Local Dev: "No Lambda function URL configured"

**Cause:** Missing VITE_AMPLIFY_FUNCTION_URL in .env.local

**Solution:**
1. Run `npx ampx sandbox`
2. Copy the function URL from output
3. Add to `.env.local`
4. Restart `npm run dev`

### CORS Error on Form Submit

**Cause:** ALLOWED_ORIGINS doesn't match your domain

**Solution:**
- Update Parameter Store: `/amplify/ALLOWED_ORIGINS`
- Set to exact domain (e.g., `https://main.xxxxx.amplifyapp.com`)
- Redeploy

---

## ğŸ“Š Architecture Summary

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Production (Amplify Console)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  Backend:                                   â”‚
â”‚  - Lambda function                          â”‚
â”‚  - Secrets from Parameter Store             â”‚
â”‚  - Generates amplify_outputs.json           â”‚
â”‚                                             â”‚
â”‚  Build Script:                              â”‚
â”‚  - Reads amplify_outputs.json               â”‚
â”‚  - Sets VITE_AMPLIFY_FUNCTION_URL           â”‚
â”‚                                             â”‚
â”‚  Frontend:                                  â”‚
â”‚  - Reads VITE_AMPLIFY_FUNCTION_URL          â”‚
â”‚  - Bundles with function URL                â”‚
â”‚  - Deployed to CDN                          â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Local Development                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  .env.local:                                â”‚
â”‚  - RESEND_API_KEY                           â”‚
â”‚  - RESEND_RECEIVER_EMAIL                    â”‚
â”‚  - ALLOWED_ORIGINS                          â”‚
â”‚  - VITE_AMPLIFY_FUNCTION_URL                â”‚
â”‚                                             â”‚
â”‚  Sandbox: npx ampx sandbox                  â”‚
â”‚  - Creates temp Lambda                      â”‚
â”‚  - Returns function URL                     â”‚
â”‚                                             â”‚
â”‚  Dev Server: npm run dev                    â”‚
â”‚  - Reads .env.local                         â”‚
â”‚  - Hot reload on changes                    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Summary

**The fix:**
- Updated `amplify.yml` to extract function URL during build
- Backend generates `amplify_outputs.json`
- Build script reads JSON and sets env var
- Frontend uses env var (standard Vite approach)

**Result:**
- âœ… No more build errors
- âœ… Automatic function URL management
- âœ… Works in production and local dev
- âœ… Simple and maintainable

**Next step:**
Push your code and deploy!

```bash
git add .
git commit -m "Fix Amplify deployment with automatic function URL"
git push origin main
```

Monitor the deployment in Amplify Console. It should succeed now! ğŸ‰
